# Домашнее задание к занятию «Резервное копирование баз данных»
Выполнил: Нижегородов Сергей

## Задание 1. Резервное копирование
Кейс финансовой компании.
### 1.1. Восстановление данных за предыдущий день
Для такого кейса хорошо подходит **ежедневное полное резервное копирование**. Делаем полный бэкап каждый день вечером, после закрытия операционного дня. Если что-то случится - просто берем вчерашний бэкап и восстанавливаем.

### 1.2. Восстановление данных за час до поломки  
Здесь нужен **комбинированный подход**: 
- Ежедневные полные бэкапы
- Плюс **инкрементные бэкапы каждый час**

Так можно восстановить данные на момент последнего инкрементного бэкапа.

### 1.3. Моментальное переключение при поломке
Да, такой кейс возможен! Это называется **High Availability (высокая доступность)**. Нужно настроить:
- **Репликацию в режиме master-slave** или **master-master**
- **Автоматический failover** - система сама переключает трафик на рабочую базу
- **Мониторинг** за состоянием баз данных

## Задание 2. PostgreSQL

### 2.1. Команды резервирования и восстановления

**Создание резервной копии (pg_dump):**
```bash
# Полный дамп базы данных
pg_dump -U username -h localhost -d database_name -F c -b -v -f backup_file.dump

# Только схема (без данных)
pg_dump -U username -s database_name > schema.sql

# Только данные определенной таблицы
pg_dump -U username -t table_name database_name > table_data.sql
```

**Восстановление (pg_restore):**
```bash
# Восстановление полного дампа
pg_restore -U username -h localhost -d database_name -v backup_file.dump

# Восстановление в новую базу
createdb new_database
pg_restore -U username -d new_database backup_file.dump
```

### 2.2. Автоматизация процесса
Да, процесс можно полностью автоматизировать! Вот как:

1. **Скрипты на bash** с расписанием в cron:
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
pg_dump -U postgres mydb > /backups/mydb_$DATE.sql
# Удаляем старые бэкапы (старше 30 дней)
find /backups -name "*.sql" -mtime +30 -delete
```

2. **Использование утилиты pgBackRest** или **Barman** - профессиональные инструменты

3. **Интеграция с облачными хранилищами** для хранения бэкапов

4. **Мониторинг и уведомления** - отправка email если бэкап не удался

## Задание 3. MySQL

### 3.1. Инкрементное резервное копирование MySQL

**Пример команды для инкрементного бэкапа:**
```bash
# 1. Сначала делаем полный бэкап
mysqldump --all-databases --single-transaction --flush-logs --master-data=2 > full_backup.sql

# 2. Включаем бинарное логирование (если еще не включено)
# В конфиге my.cnf: log-bin=mysql-bin

# 3. Делаем инкрементные бэкапы (используем бинарные логи)
# Каждый следующий бэкап будет содержать только изменения
mysqlbinlog mysql-bin.000001 > incremental_backup_1.sql
mysqlbinlog mysql-bin.000002 > incremental_backup_2.sql
mysqlbinlog mysql-bin.000003 > incremental_backup_3.sql

# 4. Можно автоматизировать через скрипт:
#!/bin/bash
# Ротация бинарных логов
mysql -e "FLUSH BINARY LOGS"
# Бэкап последнего бинарного лога
LAST_LOG=$(mysql -e "SHOW BINARY LOGS" | tail -1 | awk '{print $1}')
mysqlbinlog $LAST_LOG > /backups/incremental_$(date +%Y%m%d_%H%M%S).sql
```

**Восстановление из инкрементных бэкапов:**
```bash
# 1. Восстанавливаем полный бэкап
mysql < full_backup.sql

# 2. Применяем инкрементные бэкапы по порядку
mysql < incremental_backup_1.sql
mysql < incremental_backup_2.sql
mysql < incremental_backup_3.sql
```

### 3.2. Преимущества реплики перед обычным бэкапом

**Реплика дает преимущества когда:**

1. **Нужна минимальная потеря данных** - при падении мастера на реплике уже есть почти все данные
2. **Требуется быстрое переключение** - failover на реплику происходит за секунды, а восстановление из бэкапа может занимать часы
3. **Высокая доступность** - реплика всегда "горячая" и готова к работе
4. **Разгрузка основной базы** - можно направлять запросы на чтение на реплику
5. **Геораспределение** - можно иметь реплики в разных регионах

**Обычный бэкап лучше когда:**
- Нужна "заморозка" данных на определенный момент времени
- Для аудита или соответствия регуляторным требованиям
- Защита от человеческих ошибок (например, случайное удаление данных)
- Долгосрочное хранение архивных данных
